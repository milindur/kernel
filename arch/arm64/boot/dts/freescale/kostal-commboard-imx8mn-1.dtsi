/*
 * Copyright 2019 NXP
 * Copyright (c) 2022 KOSTAL Industrie Elektrik GmbH. All rights reserved.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 */

/dts-v1/;

#include <dt-bindings/usb/pd.h>
#include <dt-bindings/leds/common.h>
#include "imx8mn.dtsi"

/ {
    model = "KOSTAL COM-Board i.MX8MN-1";
    compatible = "kostal,kcbmx8mn", "fsl,imx8mn-evk", "fsl,imx8mn";

    chosen {
        bootargs = "console=ttymxc1,115200 earlycon=ec_imx6q,0x30890000,115200";
        stdout-path = &uart2;
    };

    leds {
        compatible = "gpio-leds";
        pinctrl-names = "default";
        pinctrl-0 = <&pinctrl_gpio_led>;

        status {
            function = LED_FUNCTION_BOOT;
            color = <LED_COLOR_ID_GREEN>;
            linux,default-trigger = "heartbeat";
            gpios = <&gpio1 10 GPIO_ACTIVE_LOW>;
        };

        error {
            function = LED_FUNCTION_BOOT;
            color = <LED_COLOR_ID_RED>;
            linux,default-trigger = "panic";
            gpios = <&gpio1 11 GPIO_ACTIVE_LOW>;
        };
    };

    aliases {
        rtc0 = &i2c_rtc;
        rtc1 = &snvs_rtc;
    };
};

&A53_0 {
    cpu-supply = <&buck2_reg>;
};

&i2c1 {
    clock-frequency = <400000>;
    pinctrl-names = "default";
    pinctrl-0 = <&pinctrl_i2c1>;
    status = "okay";

    pmic: pca9450@25 {
        reg = <0x25>;
        compatible = "nxp,pca9450b";
        pinctrl-0 = <&pinctrl_pmic>;
        interrupt-parent = <&gpio1>;
        interrupts = <3 IRQ_TYPE_LEVEL_LOW>;

        regulators {
            #address-cells = <1>;
            #size-cells = <0>;

            pca9450,pmic-buck2-uses-i2c-dvs;
            /* Run/Standby voltage */
            pca9450,pmic-buck2-dvs-voltage = <950000>, <850000>;

            buck1_reg: BUCK1 {
                regulator-name = "BUCK1";
                regulator-min-microvolt = <600000>;
                regulator-max-microvolt = <2187500>;
                regulator-boot-on;
                regulator-always-on;
                regulator-ramp-delay = <3125>;
            };

            buck2_reg: BUCK2 {
                regulator-name = "BUCK2";
                regulator-min-microvolt = <600000>;
                regulator-max-microvolt = <2187500>;
                regulator-boot-on;
                regulator-always-on;
                regulator-ramp-delay = <3125>;
            };

            buck3_reg: BUCK3 {
                regulator-name = "BUCK3";
                regulator-min-microvolt = <600000>;
                regulator-max-microvolt = <2187500>;
                regulator-boot-on;
                regulator-always-on;
            };

            buck4_reg: BUCK4 {
                regulator-name = "BUCK4";
                regulator-min-microvolt = <600000>;
                regulator-max-microvolt = <3400000>;
                regulator-boot-on;
                regulator-always-on;
            };

            buck5_reg: BUCK5 {
                regulator-name = "BUCK5";
                regulator-min-microvolt = <600000>;
                regulator-max-microvolt = <3400000>;
                regulator-boot-on;
                regulator-always-on;
            };

            buck6_reg: BUCK6 {
                regulator-name = "BUCK6";
                regulator-min-microvolt = <600000>;
                regulator-max-microvolt = <3400000>;
                regulator-boot-on;
                regulator-always-on;
            };

            ldo1_reg: LDO1 {
                regulator-name = "LDO1";
                regulator-min-microvolt = <1600000>;
                regulator-max-microvolt = <3300000>;
                regulator-boot-on;
                regulator-always-on;
            };

            ldo2_reg: LDO2 {
                regulator-name = "LDO2";
                regulator-min-microvolt = <800000>;
                regulator-max-microvolt = <1150000>;
                regulator-boot-on;
                regulator-always-on;
            };

            ldo3_reg: LDO3 {
                regulator-name = "LDO3";
                regulator-min-microvolt = <800000>;
                regulator-max-microvolt = <3300000>;
                regulator-boot-on;
                regulator-always-on;
            };

            ldo4_reg: LDO4 {
                regulator-name = "LDO4";
                regulator-min-microvolt = <800000>;
                regulator-max-microvolt = <3300000>;
                regulator-boot-on;
                regulator-always-on;
            };

            ldo5_reg: LDO5 {
                regulator-name = "LDO5";
                regulator-min-microvolt = <1800000>;
                regulator-max-microvolt = <3300000>;
            };
        };
    };
};

&i2c2 {
    // RFID
    clock-frequency = <100000>;
    pinctrl-names = "default";
    pinctrl-0 = <&pinctrl_i2c2>;
    status = "okay";
};

&i2c3 {
    //DSI
    clock-frequency = <100000>;
    pinctrl-names = "default";
    pinctrl-0 = <&pinctrl_i2c3>;
    status = "okay";
};

&i2c4 {
    clock-frequency = <400000>;
    pinctrl-names = "default";
    pinctrl-0 = <&pinctrl_i2c4>;
    status = "okay";

    i2c_rtc: rtc@51 {
        compatible = "nxp,pcf8563";
        reg = <0x51>;
        #clock-cells = <0>;
        pinctrl-names = "default";
        pinctrl-0 = <&pinctrl_rtc_int>;
        interrupt-parent = <&gpio1>;
        interrupts = <0 IRQ_TYPE_LEVEL_LOW>;
    };
};

&fec1 {
    pinctrl-names = "default";
    pinctrl-0 = <&pinctrl_fec1>;
    phy-mode = "rgmii";
    phy-reset-gpios = <&gpio2 19 GPIO_ACTIVE_LOW>;
    phy-reset-duration = <10>;
    phy-reset-post-delay = <20>;
    phy-supply = <&buck4_reg>;
    fsl,magic-packet;
    status = "okay";

    fixed-link {
        speed = <100>;
        full-duplex;
    };

    mdio {
        #address-cells = <1>;
        #size-cells = <0>;

        switch@0 {
            compatible = "marvell,mv88e6250";
            reg = <0x00>;

            interrupt-parent = <&gpio2>;
            interrupts = <20 IRQ_TYPE_LEVEL_LOW>;
            interrupt-controller;
            #interrupt-cells = <2>;

            ports {
                #address-cells = <1>;
                #size-cells = <0>;

                port@0 {
                    reg = <0>;
                    label = "lan1";
                };

                port@1 {
                    reg = <1>;
                    label = "lan2";
                };

                port@2 {
                    reg = <2>;
                    label = "lan3";
                };

                port@5 {
                    reg = <5>;
                    label = "cpu";
                    phy-mode = "rgmii-id";
                    ethernet = <&fec1>;

                    fixed-link {
                           speed = <100>;
                           full-duplex;
                    };
                };
            };
        };
    };
};

&snvs_pwrkey {
    status = "okay";
};

&uart1 { /* RS485 on ttymxc0 */
    pinctrl-names = "default";
    pinctrl-0 = <&pinctrl_uart1>;
    rs485-rx-during-tx;
    rts-gpios = <&gpio4 24 GPIO_ACTIVE_HIGH>;
    linux,rs485-enabled-at-boot-time;
    status = "okay";
};

&uart2 { /* console */
    pinctrl-names = "default";
    pinctrl-0 = <&pinctrl_uart2>;
    status = "okay";
};

&uart3 { /* extern */
    pinctrl-names = "default";
    pinctrl-0 = <&pinctrl_uart3>;
    fsl,uart-has-rtscts;
    status = "okay";
};

&usdhc2 { /* SD card - not working with current hardware */
    status = "disabled";
};

&usdhc3 { /* eMMC */
    pinctrl-names = "default", "state_100mhz", "state_200mhz";
    pinctrl-0 = <&pinctrl_usdhc3>;
    pinctrl-1 = <&pinctrl_usdhc3_100mhz>;
    pinctrl-2 = <&pinctrl_usdhc3_200mhz>;
    bus-width = <8>;
    non-removable;
    status = "okay";
};

&wdog1 {
    pinctrl-names = "default";
    pinctrl-0 = <&pinctrl_wdog>;
    fsl,ext-reset-output;
    status = "okay";
};

&gpu {
    status = "okay";
};

&iomuxc {
    pinctrl-names = "default";

    imx8mn-evk {
        pinctrl_fec1: fec1grp {
            fsl,pins = <
                MX8MN_IOMUXC_ENET_MDC_ENET1_MDC                 0x3
                MX8MN_IOMUXC_ENET_MDIO_ENET1_MDIO               0x3
                MX8MN_IOMUXC_ENET_TD3_ENET1_RGMII_TD3           0x1f
                MX8MN_IOMUXC_ENET_TD2_ENET1_RGMII_TD2           0x1f
                MX8MN_IOMUXC_ENET_TD1_ENET1_RGMII_TD1           0x1f
                MX8MN_IOMUXC_ENET_TD0_ENET1_RGMII_TD0           0x1f
                MX8MN_IOMUXC_ENET_RD3_ENET1_RGMII_RD3           0x191 // low
                MX8MN_IOMUXC_ENET_RD2_ENET1_RGMII_RD2           0x191 // low nicht schÃ¶n 0.7V
                MX8MN_IOMUXC_ENET_RD1_ENET1_RGMII_RD1           0x191 // low
                MX8MN_IOMUXC_ENET_RD0_ENET1_RGMII_RD0           0x1D1 // high
                MX8MN_IOMUXC_ENET_TXC_ENET1_RGMII_TXC           0x1f
                MX8MN_IOMUXC_ENET_RXC_ENET1_RGMII_RXC           0x91
                MX8MN_IOMUXC_ENET_RX_CTL_ENET1_RGMII_RX_CTL     0x91
                MX8MN_IOMUXC_ENET_TX_CTL_ENET1_RGMII_TX_CTL     0x1f
                MX8MN_IOMUXC_SD2_RESET_B_GPIO2_IO19             0x19
                MX8MN_IOMUXC_SD2_WP_GPIO2_IO20                  0x159
            >;
        };

        pinctrl_gpio_led: gpioledgrp {
            fsl,pins = <
                MX8MN_IOMUXC_GPIO1_IO10_GPIO1_IO10          0x19
                MX8MN_IOMUXC_GPIO1_IO11_GPIO1_IO11          0x19
            >;
        };

        pinctrl_i2c1: i2c1grp {
            fsl,pins = <
                MX8MN_IOMUXC_I2C1_SCL_I2C1_SCL              0x400001c3
                MX8MN_IOMUXC_I2C1_SDA_I2C1_SDA              0x400001c3
            >;
        };

        pinctrl_pmic: pmicirq {
            fsl,pins = <
                MX8MN_IOMUXC_GPIO1_IO03_GPIO1_IO3           0x41
            >;
        };

        pinctrl_i2c2: i2c2grp {
            fsl,pins = <
                MX8MN_IOMUXC_I2C2_SCL_I2C2_SCL              0x400001c3
                MX8MN_IOMUXC_I2C2_SDA_I2C2_SDA              0x400001c3
            >;
        };

        pinctrl_i2c3: i2c3grp {
            fsl,pins = <
                MX8MN_IOMUXC_I2C3_SCL_I2C3_SCL              0x400001c3
                MX8MN_IOMUXC_I2C3_SDA_I2C3_SDA              0x400001c3
            >;
        };

        pinctrl_i2c4: i2c4grp {
            fsl,pins = <
                MX8MN_IOMUXC_I2C4_SCL_I2C4_SCL               0x400001c3
                MX8MN_IOMUXC_I2C4_SDA_I2C4_SDA              0x400001c3
            >;
        };

        pinctrl_rtc_int: rtcint {
            fsl,pins = <
                MX8MN_IOMUXC_GPIO1_IO00_GPIO1_IO0           0x140
            >;
        };

        pinctrl_uart1: uart1grp {
            fsl,pins = <
                MX8MN_IOMUXC_SAI2_RXFS_UART1_DCE_TX         0x140
                MX8MN_IOMUXC_SAI2_RXC_UART1_DCE_RX          0x140
                MX8MN_IOMUXC_SAI2_TXFS_GPIO4_IO24           0x00
            >;
        };

        pinctrl_uart2: uart2grp {
            fsl,pins = <
                MX8MN_IOMUXC_SAI3_TXFS_UART2_DCE_RX         0x140
                MX8MN_IOMUXC_SAI3_TXC_UART2_DCE_TX          0x140
            >;
        };

        pinctrl_uart3: uart3grp {
            fsl,pins = <
                MX8MN_IOMUXC_UART3_RXD_UART3_DCE_RX         0x140
                MX8MN_IOMUXC_UART3_TXD_UART3_DTE_RX         0x140
                MX8MN_IOMUXC_SD1_STROBE_UART3_DCE_CTS_B     0x140
                MX8MN_IOMUXC_SD1_RESET_B_UART3_DCE_RTS_B    0x140
            >;
        };

        pinctrl_usdhc3: usdhc3grp {
            fsl,pins = <
                MX8MN_IOMUXC_NAND_WE_B_USDHC3_CLK           0x190
                MX8MN_IOMUXC_NAND_WP_B_USDHC3_CMD           0x1d0
                MX8MN_IOMUXC_NAND_DATA04_USDHC3_DATA0       0x1d0
                MX8MN_IOMUXC_NAND_DATA05_USDHC3_DATA1       0x1d0
                MX8MN_IOMUXC_NAND_DATA06_USDHC3_DATA2       0x1d0
                MX8MN_IOMUXC_NAND_DATA07_USDHC3_DATA3       0x1d0
                MX8MN_IOMUXC_NAND_RE_B_USDHC3_DATA4         0x1d0
                MX8MN_IOMUXC_NAND_CE2_B_USDHC3_DATA5        0x1d0
                MX8MN_IOMUXC_NAND_CE3_B_USDHC3_DATA6        0x1d0
                MX8MN_IOMUXC_NAND_CLE_USDHC3_DATA7          0x1d0
                MX8MN_IOMUXC_NAND_CE1_B_USDHC3_STROBE       0x190
            >;
        };

        pinctrl_usdhc3_100mhz: usdhc3grp100mhz {
            fsl,pins = <
                MX8MN_IOMUXC_NAND_WE_B_USDHC3_CLK           0x194
                MX8MN_IOMUXC_NAND_WP_B_USDHC3_CMD           0x1d4
                MX8MN_IOMUXC_NAND_DATA04_USDHC3_DATA0       0x1d4
                MX8MN_IOMUXC_NAND_DATA05_USDHC3_DATA1       0x1d4
                MX8MN_IOMUXC_NAND_DATA06_USDHC3_DATA2       0x1d4
                MX8MN_IOMUXC_NAND_DATA07_USDHC3_DATA3       0x1d4
                MX8MN_IOMUXC_NAND_RE_B_USDHC3_DATA4         0x1d4
                MX8MN_IOMUXC_NAND_CE2_B_USDHC3_DATA5        0x1d4
                MX8MN_IOMUXC_NAND_CE3_B_USDHC3_DATA6        0x1d4
                MX8MN_IOMUXC_NAND_CLE_USDHC3_DATA7          0x1d4
                MX8MN_IOMUXC_NAND_CE1_B_USDHC3_STROBE       0x194
            >;
        };

        pinctrl_usdhc3_200mhz: usdhc3grp200mhz {
            fsl,pins = <
                MX8MN_IOMUXC_NAND_WE_B_USDHC3_CLK           0x196
                MX8MN_IOMUXC_NAND_WP_B_USDHC3_CMD           0x1d6
                MX8MN_IOMUXC_NAND_DATA04_USDHC3_DATA0       0x1d6
                MX8MN_IOMUXC_NAND_DATA05_USDHC3_DATA1       0x1d6
                MX8MN_IOMUXC_NAND_DATA06_USDHC3_DATA2       0x1d6
                MX8MN_IOMUXC_NAND_DATA07_USDHC3_DATA3       0x1d6
                MX8MN_IOMUXC_NAND_RE_B_USDHC3_DATA4         0x1d6
                MX8MN_IOMUXC_NAND_CE2_B_USDHC3_DATA5        0x1d6
                MX8MN_IOMUXC_NAND_CE3_B_USDHC3_DATA6        0x1d6
                MX8MN_IOMUXC_NAND_CLE_USDHC3_DATA7          0x1d6
                MX8MN_IOMUXC_NAND_CE1_B_USDHC3_STROBE       0x196
            >;
        };

        pinctrl_wdog: wdoggrp {
            fsl,pins = <
                MX8MN_IOMUXC_GPIO1_IO02_WDOG1_WDOG_B        0xc6
            >;
        };
    };
};
